# IDENTITY & CONTEXT
- I am a Senior Software Engineer specializing in Ruby on Rails 8, Hotwire, and "Clean Code."
- I value explicit, transparent Ruby code over "Gem Magic" (Devise, ActiveAdmin, etc.).
- I prefer explicitly named variables over "magic."

# GAMESCORE PROJECT CONTEXT (Rails 8 Rebuild)
- **Stack:** Ruby 3.x, Rails 8, PostgreSQL.
- **Defaults:** Solid Queue (Jobs), Solid Cache (Caching), Propshaft (Assets), Kamal (Deploy).
- **Primary Keys:** Integer/bigint IDs (Default). Do NOT use UUIDs unless explicitly required.
- **Frontend:** Hotwire (Turbo/Stimulus), ViewComponents, Vanilla CSS (BEM). **NO TAILWIND.**
- **Philosophy:** "Omakase" Rails but with a strong preference for Service Objects and POROs.
- **Auth:** Native Rails 8 Authentication (No Devise).

# LIVING DOCUMENTATION (The Source of Truth)
The `docs/` folder is authoritative. You must consult these files before implementing features:
1. **Business Logic:** `docs/SPEC.md` (Scoring rules, Polymorphic Results).
2. **UI/Components:** `docs/design/ui_implementation_master.md` (The Consolidated UI Master Plan).
3. **Accessibility:** `docs/accessibility.md` (WCAG 2.1 A/AA, skip link, focus, forms, images, Turbo). All new UI must follow it.
4. **Security:** `docs/secrets_management.md` (Env vars, Credentials).
5. **i18n:** `docs/i18n_localization_guide.md` (Strict localization rules).
6. **Architecture:** `docs/architectural_patterns_in_ruby_on_rails.md` (Service Objects vs Concerns).
7. **Documentation maintenance:** `docs/documentation_maintenance.md` (when to update docs, including `.cursorrules` / `.agent/rules/rules.md` sync).
8. **Legacy naming:** When you rename or add a mapping between `/old` and `/game_scores`, update **`docs/legacy_naming_map.md`**. Do not reintroduce legacy names in the new app; CI runs `script/check_legacy_names` to catch them.
9. **JavaScript testing:** `docs/javascript_testing.md` (Vitest, coverage, running and writing controller specs).
10. **Changelog:** When your change is user-facing, a fix, or a notable dependency/config change, update **CHANGELOG.md** (entry under `[Unreleased]`). See CHANGELOG.md section "When to update this file."

# BEHAVIORAL RULES (Development)
- **Documentation First:** Before writing code, read the relevant doc from `docs/`.
- **Definition of Done:** A task is NOT complete until you have updated the relevant `docs/` file to reflect your changes.
- **Refactoring:** When modifying legacy code, migrate logic from client-side (CoffeeScript) to server-side (Ruby Service Objects).
- **Naming Conventions:** Booleans must answer a question (`active?`, `is_active`, `can_edit`). No single-letter variables except `i`/`j` in loops.
- **Single Responsibility (SRP):** If a file imports > 10 distinct modules/packages, flag it for splitting.

# FRONTEND ARCHITECTURE (The Rails Way)
1. **HTML First:** Default to server-rendered HTML. Do not reach for React/Vue unless the interaction is highly complex.
2. **Hotwire (Turbo):**
   - **Turbo Drive:** Enabled by default.
   - **Turbo Frames:** Use for localized page updates (modals, inline editing, tabs).
   - **Turbo Streams:** Use for real-time broadcast updates or complex form responses.
   - **Morphing:** Prefer Turbo 8 Page Refreshes (Morphing) over complex stream actions when possible.
3. **ViewComponents:** Prefer `ViewComponent::Base` over standard partials for any UI element with logic or arguments. Co-locate the Ruby class, HTML template, and component spec.
4. **Stimulus JS:** "Sprinkles" of behavior only (toggles, fetches). Use `data-values` for state. Avoid inline JS.

# CODE QUALITY & LINTING
1. **Strict Compliance:** Treat **RuboCop**, **Reek**, and **ESLint** (`eslint.config.mjs`) violations as errors.
2. **Universal Quality:**
   - **Cyclomatic Complexity:** Keep logic flat. Extract private methods.
   - **Guard Clauses:** Prefer `return unless` over nested blocks.
   - **Naming:** Booleans must ask questions (`active?`).
3. **Pre-flight Check:** No trailing whitespace. Use double quotes for string literals (RuboCop/omakase: `Style/StringLiterals`); single quotes only when escaping is required. No unused variables. Strictly adhere to the 5-line method rule unless impossible.
4. **The "Kill List" (Strictly Forbidden):** Tailwind classes (Use `var(--color-...)` instead). Devise helpers (Use `Current.user`). jQuery (Use Stimulus).

# SANDI METZ'S RULES (Strict Enforcement)
1. **Class Length:** Max **100 lines**.
2. **Method Length:** Max **5 lines**.
3. **Parameters:** Max **3 parameters** (use configuration objects or hashes for more).
4. **Controller State:** Controllers can instantiate **only one object** per action.
   - *Tip:* Use Facades/Presenters if a view needs multiple models.

# RAILS ARCHITECTURE PATTERNS
1. **Fat Models, Skinny Controllers:** Logic belongs in Models or Services.
2. **Service Objects > Concerns:** Do NOT use ActiveSupport::Concern for single-model logic. DO use Service Objects for processes (e.g., `ScoreCalculator.new(round).call`).
3. **Solid Queue:** Prefer Active Job over direct Redis calls.
4. **Law of Demeter:** Use `delegate` to avoid dot-chains (`user.department.name`).
5. **Polymorphism:** Respect the `Result` model schema (`resultable` / `positionable`).

# TESTING (RSpec & JavaScript)
1. **RSpec:** Arrange, Act, Assert. Use `build_stubbed` over `create` where possible. System tests use Cuprite/Headless Chrome for Hotwire. No private testing: test the public interface or extract to a Service Object. See `docs/testing_private_methods_in_rails.md`.
2. **JavaScript (Vitest):** Stimulus controllers are unit-tested with Vitest and happy-dom. Run `npm run test` or `rake javascript_tests`. Coverage is enforced (100% lines/functions/statements, 96% branches). New controllers require specs in `app/javascript/controllers/__tests__/`. See `docs/javascript_testing.md`.
3. **Enforcement:** The default Rake task runs `javascript_tests` then `spec`; CI runs both. Both suites must pass.

# INTERNATIONALIZATION (i18n) PROTOCOL
- **Strict Prohibition:** NEVER leave hardcoded strings in Controllers, Models, Helpers, Mailers, or Views.
- **Implementation Pattern:** Use `I18n.t("context.action.message")`. Use interpolation: `I18n.t("welcome", name: @user.name)` (never string concatenation). For attributes, use Rails standard `activerecord.attributes.model_name.attr`.
- **Validation Messages:** Use symbols for keys (e.g., `message: :invalid_format`).
- **Defaults:** When migrating legacy code, if no translation exists, use `I18n.t("key", default: "Original Text")`.
- **Flash messages:** Use `notice` or `success` for success (toasts), `alert` or `error` for errors (banners). Never hardcode flash text; use i18n. See `docs/flash_messages.md`.

# DOCUMENTATION & CHANGELOG
- **CHANGELOG.md:** When a PR adds a user-facing change, fix, or notable dependency/config change, update **CHANGELOG.md** (add an entry under `[Unreleased]`). See CHANGELOG.md section "When to update this file."
- **Living docs:** When implementing features, update the relevant `docs/` file. When shipping a release, move `[Unreleased]` entries in CHANGELOG into a new version section.
- **Agent rules:** When you change this file (`.cursorrules`) or **`.agent/rules/rules.md`**, update the other so Cursor and Antigravity stay in sync.

# UNIVERSAL BEHAVIOR
- **No Yapping:** Output code immediately.
- **Diffs:** Show only changed lines with context.
- **Refactoring:** Apply the Boy Scout Rule (leave code cleaner).
- **Dead Code:** Remove commented-out code immediately.

# FRAMEWORK SPECIFIC STANDARDS (Strict)

## 1. ViewComponents
- **Logic Leakage:** NEVER make database queries inside `render` or `initialize`. Components must receive data, not fetch it.
- **Full sidecar (one folder):** Each component lives in its own folder; all sidecar assets (template, CSS, JS) must be inside that folder alongside the `.rb` file (e.g. `app/components/cards/stat_component/stat_component.css`). See `docs/COMPONENT_PATTERNS.md`.
- **Argument Hash:** If a Component takes > 3 arguments, use a configuration object or keyword arguments.
- **Flash messages:** Implemented as shared partial + Stimulus + global CSS (not a ViewComponent). See `docs/flash_messages.md` and `docs/COMPONENT_PATTERNS.md` (Shared UI).

## 2. Stimulus Controllers
- **Lifecycle Management:** If you add an event listener or timer in `connect()`, you MUST remove it in `disconnect()`.
- **Values API:** Use `static values` (e.g., `static values = { id: Number }`) instead of manually parsing `dataset` attributes.
- **Targeting:** Use `static targets` instead of `document.querySelector`.
- **No jQuery:** STRICTLY FORBIDDEN. Use native DOM APIs (`this.element`, `event.target`).

## 3. Turbo & Hotwire
- **Frame IDs:** Ensure `turbo_frame_tag` IDs match the backend response exactly.
- **Efficiency:** Prefer **Turbo Streams** (append/prepend/replace) over full **Turbo Frame** reloads whenever possible.
- **"Div Soup":** Avoid wrapping Turbo Frames in unnecessary `<div>` tags unless strictly required for layout.

## 4. Service & Query Objects
- **Controller Logic:** If a Controller action contains ranking, scoring, or complex filtering logic, extract it to a **Service Object** immediately (e.g., `RoundScoreCalculator`).
- **Fat Models:** If a Model has complex scopes or SQL chains, extract it to a **Query Object** (e.g., `Stats::PositionsQuery`).
- **Callbacks:** Avoid complex logic in `after_save` callbacks. Use Service Objects to handle multi-step updates.

# ACCESSIBILITY (a11y)
- **Standard:** WCAG 2.1 Level A and AA. See `docs/accessibility.md`.
- **Required:** Follow the mandatory patterns in `docs/accessibility.md` (skip links, focus visibility, accessible forms, image alt text, and color contrast). All new views must adhere to these standards.
- **Testing:** System specs run axe (axe-core-capybara) via `expect(page).to be_accessible`. All new public or auth pages must be added to `spec/system/accessibility_spec.rb`; CI runs these specs.
